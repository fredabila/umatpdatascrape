<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Data Query</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .loader {
        border-top-color: #3498db;
        -webkit-animation: spinner 1.5s linear infinite;
        animation: spinner 1.5s linear infinite;
      }
      @-webkit-keyframes spinner {
        0% {
          -webkit-transform: rotate(0deg);
        }
        100% {
          -webkit-transform: rotate(360deg);
        }
      }
      @keyframes spinner {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body
    class="bg-gray-100 min-h-screen flex flex-col items-center justify-start px-4 py-8"
  >
    <div class="container max-w-4xl mx-auto">
      <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
        <div
          class="bg-blue-600 text-white py-4 px-6 flex justify-between items-center"
        >
          <h2 class="text-2xl font-bold">Student Data Query</h2>
          <div>
            <input
              type="number"
              id="startNumber"
              placeholder="Start Number"
              min="1"
              max="9999"
              class="px-2 py-1 rounded-md text-black"
              value="1"
            />
            <input
              type="number"
              id="endNumber"
              placeholder="End Number"
              min="1"
              max="9999"
              class="px-2 py-1 rounded-md text-black"
              value="10"
            />
            <button
              onclick="fetchStudentData()"
              class="bg-white text-blue-600 px-4 py-1 rounded-md hover:bg-blue-100 transition duration-300"
            >
              Fetch Data
            </button>
          </div>
        </div>
        <div
          id="studentDataContainer"
          class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6"
        >
          <!-- Student data will be dynamically inserted here -->
        </div>
        <div class="p-6 flex justify-between items-center">
          <button
            id="prevButton"
            onclick="changePage(-1)"
            class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition duration-300"
          >
            Previous
          </button>
          <span id="pageInfo" class="text-gray-600"></span>
          <button
            id="nextButton"
            onclick="changePage(1)"
            class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition duration-300"
          >
            Next
          </button>
        </div>
        <div class="p-6 flex justify-center space-x-4">
          <button
            onclick="exportPhoneNumbers(1)"
            class="bg-green-500 text-white px-6 py-2 rounded-md hover:bg-green-600 transition duration-300"
          >
            Export Method 1
          </button>
          <button
            onclick="exportPhoneNumbers(2)"
            class="bg-green-500 text-white px-6 py-2 rounded-md hover:bg-green-600 transition duration-300"
          >
            Export Method 2
          </button>
          <button
            onclick="exportPhoneNumbers(3)"
            class="bg-green-500 text-white px-6 py-2 rounded-md hover:bg-green-600 transition duration-300"
          >
            Export Method 3 (CSV)
          </button>
        </div>
      </div>
    </div>

    <div
      id="loader"
      class="hidden fixed top-0 left-0 right-0 bottom-0 w-full h-screen z-50 overflow-hidden bg-gray-700 opacity-75 flex flex-col items-center justify-center"
    >
      <div
        class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"
      ></div>
      <h2 class="text-center text-white text-xl font-semibold">Loading...</h2>
      <p class="w-1/3 text-center text-white">
        This may take a few seconds, please don't close this page.
      </p>
    </div>

    <script>
      let studentData = [];
      let currentPage = 1;
      const studentsPerPage = 4;

      function fetchStudentData() {
        const startNumber = parseInt(
          document.getElementById("startNumber").value
        );
        const endNumber = parseInt(document.getElementById("endNumber").value);

        if (startNumber > endNumber || startNumber < 1 || endNumber > 9999) {
          alert("Please enter valid start and end numbers (1-9999)");
          return;
        }

        const loader = document.getElementById("loader");
        loader.classList.remove("hidden");

        studentData = [];
        const fetchPromises = [];

        for (let i = startNumber; i <= endNumber; i++) {
          const paddedNumber = i.toString().padStart(4, "0");
          const studentNumber = `9014${paddedNumber}24`;
          const apiUrl = `https://portal.umat.edu.gh/api-v1/live/admissions//api/Admission/GetApplicationBasicData?studentNumber=${studentNumber}`;

          fetchPromises.push(
            fetch(apiUrl)
              .then((response) => response.json())
              .then((data) => {
                if (data) studentData.push(data);
              })
              .catch((error) =>
                console.error(
                  `Error fetching data for student ${studentNumber}:`,
                  error
                )
              )
          );
        }

        Promise.all(fetchPromises).then(() => {
          currentPage = 1;
          displayStudentData();
          loader.classList.add("hidden");
        });
      }

      function displayStudentData() {
        const container = document.getElementById("studentDataContainer");
        container.innerHTML = "";

        const startIndex = (currentPage - 1) * studentsPerPage;
        const endIndex = startIndex + studentsPerPage;
        const pageStudents = studentData.slice(startIndex, endIndex);

        pageStudents.forEach((student) => {
          const formattedPhone = formatPhoneNumber(student.PrimaryNumber);
          const studentCard = `
                    <div class="bg-gray-50 p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-2">${
                          student.ApplicatantFullName
                        }</h3>
                        <p><strong>Student Number:</strong> ${
                          student.StudentNumber
                        }</p>
                        <p><strong>Programme:</strong> ${
                          student.ProgrammeFullName
                        }</p>
                        <p><strong>Campus:</strong> ${student.Campus}</p>
                        <p><strong>Email:</strong> ${student.Email || "N/A"}</p>
                        <p><strong>Phone:</strong> ${
                          formattedPhone || "N/A"
                        }</p>
                        <p><strong>Gender:</strong> ${
                          student.GenderName || "N/A"
                        }</p>
                        <p>                        <p><strong>Gender:</strong> ${
                          student.GenderName || "N/A"
                        }</p>
                    </div>
                `;
          container.innerHTML += studentCard;
        });

        updatePageInfo();
      }

      function formatPhoneNumber(phoneNumber) {
        if (phoneNumber && phoneNumber.length === 10) {
          return `+233${phoneNumber.slice(1)}`;
        }
        return phoneNumber;
      }

      function updatePageInfo() {
        const pageInfo = document.getElementById("pageInfo");
        const totalPages = Math.ceil(studentData.length / studentsPerPage);
        pageInfo.innerText = `Page ${currentPage} of ${totalPages}`;

        document.getElementById("prevButton").disabled = currentPage === 1;
        document.getElementById("nextButton").disabled =
          currentPage === totalPages;
      }

      function changePage(direction) {
        const totalPages = Math.ceil(studentData.length / studentsPerPage);
        currentPage += direction;
        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages) currentPage = totalPages;
        displayStudentData();
      }

      function exportPhoneNumbers(method) {
        let phoneNumbers = studentData.map((student) => student.PrimaryNumber);
        phoneNumbers = phoneNumbers.filter(
          (phone) => phone && phone.length === 10
        ); // Filter valid phone numbers

        if (method === 1) {
          // Method 1: Export as comma-separated string with +233 prefix
          const formattedNumbers = phoneNumbers
            .map((phone) => `+233${phone.slice(1)}`)
            .join(",");
          const blob = new Blob([formattedNumbers], { type: "text/plain" });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "phone_numbers_method_1.txt";
          link.click();
        } else if (method === 2) {
          // Method 2: Export vertically with +233 prefix
          const formattedNumbers = phoneNumbers
            .map((phone) => `+233${phone.slice(1)}`)
            .join("\n");
          const blob = new Blob([formattedNumbers], { type: "text/plain" });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "phone_numbers_method_2.txt";
          link.click();
        } else if (method === 3) {
          // Method 3: Export as CSV without +233 prefix, with a random filename
          const randomNumber = Math.floor(Math.random() * 10000);
          const formattedNumbers = phoneNumbers.join("\n");
          const csvContent = `data:text/csv;charset=utf-8,${formattedNumbers}`;
          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.href = encodedUri;
          link.download = `umat_${randomNumber}.csv`;
          link.click();
        }
      }
    </script>
  </body>
</html>
